/* 2015-06-25 */ Object.prototype.equals=function(a){return this==a?!0:void 0},Date.prototype.getString=function(){var a=this.getFullYear().toString(),b=(this.getMonth()+1).toString(),c=this.getDate().toString();return a+(b[1]?b:"0"+b[0])+(c[1]?c:"0"+c[0])},Array.prototype.contains=function(a){for(var b=0;b<this.length;b++){if(this[b]==a)return!0;if(a instanceof Object&&a.equals(this[b]))return!0}return!1},Array.prototype.addAll=function(a){for(var b=0;b<a.length;b++)this.push(a[b])};var app=angular.module("board",["ngRoute"]).controller("mainController",function(a,b,c,d,e){a.$route=b,a.$location=d,a.$routeParams=c}).config(function(a,b){a.when("/:subject",{}).when("/:subject/:articleId",{}),b.html5Mode({enabled:!0,requireBase:!1})});app.findScope=function(a){return angular.element(document.querySelector(a)).scope()},app.directive("article",function(){return{templateUrl:"/js/directive/article.html",restrict:"E",scope:{},controller:function(a,b,c,d){a.user=d,a["delete"]=function(){b("/api/post",{id:c.articleId},"DELETE").success(function(a){a&&app.findScope("[ng-controller='boardController']")["delete"](c.articleId)})},a.update=function(){a.updateState=!0},a.updateDone=function(){b("/api/post",a.article,"PUT").success(function(b){b&&(app.findScope("[ng-controller='boardController']").update(a.article),a.updateState=!1)})},a.hasRight=function(){return void 0==a.article?!1:d.email==a.article.writer},a.refresh=function(){void 0!=c.articleId&&(a.info={},a.info.postId=c.articleId,a.info.end=!1,a.info.page=0,a.info.depth=0,a.replies=[],void 0==a.info.size&&(a.info.size=5),a.getReplies(),a.newReply={postId:c.articleId})},a.getReplies=function(){return a.info.end?void alert("리플이 없습니다."):(a.info.start=a.info.page*a.info.size,void b("/api/reply",a.info).success(function(b){return null==b?void(a.info.end=!0):(a.info.page++,void a.replies.addAll(b))}))},a.$watch(function(){return c.articleId},function(){void 0!=c.articleId&&(b("/api/post",{id:c.articleId}).success(function(b){return null==b?void(a.article=void 0):void(a.article=b)}),a.refresh())}),a.writeReply=function(){b("/api/reply",a.newReply,"POST").success(function(b){a.replies.push(b)})},a.deleteReply=function(a){b("/api/reply",{id:a},"DELETE").success(function(a){})}}}}),app.directive("newArticle",function(){return{templateUrl:"/js/directive/newArticle.html",restrict:"E",scope:{titles:"="},controller:function(a,b,c,d){a.user=d,a.article={},a.article.subject=c.subject,a.save=function(){b("/api/post",a.article,"POST").success(function(b){var c={};angular.copy(a.article,c),c.writer=d.email,c.id=b,void 0==a.titles&&(a.titles=[]),a.titles.push(c)})}}}}),app.directive("textarea",function(){return{restrict:"E",link:function(a,b,c){var d=b[0].offsetHeight,e=b.css("paddingLeft"),f=b.css("paddingRight"),g=angular.element("<div></div>").css({position:"absolute",top:0,opacity:0,width:b[0].offsetWidth-parseInt(e||0)-parseInt(f||0),fontSize:b.css("fontSize"),fontFamily:b.css("fontFamily"),lineHeight:b.css("lineHeight"),resize:"none"});angular.element(document.body).append(g);var h=function(){var a=function(a,b){for(var c=0,d="";b>c;c++)d+=a;return d},c=b.val().replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/&/g,"&amp;").replace(/\n$/,"<br/>&nbsp;").replace(/\n/g,"<br/>").replace(/\s{2,}/g,function(b){return a("&nbsp;",b.length-1)+" "});g.html(c),b.css("height",Math.max(g[0].offsetHeight+10,d)+"px")};b.bind("keyup keydown keypress change",h),h()}}}),app.directive("title",function(){return{templateUrl:"/js/directive/title.html",restrict:"A",scope:{title:"="},controller:function(a){}}}),app.factory("$req",function(a){var b=function(b,c,d){function e(a){var b=[];for(var c in a)"equals"!=c&&b.push(encodeURIComponent(c)+"="+encodeURIComponent(a[c]));return b.join("&")}void 0==d&&(d="GET"),void 0!=c&&(b+="?",b+=e(c));var f=a({method:d,url:b,headers:{"Content-Type":"application/x-www-form-urlencoded"}}),g=f.success;return f.success=function(a){g(function(b){a(b)})},f};return b}),app.service("$user",function(a){var b=this;a("/api/user").success(function(a){null!=a&&(b.logged=!0,b.email=a.email)})}),app.controller("boardController",function(a,b,c,d){function e(b){for(var c=0;c<a.titles.length;c++)if(a.titles[c].id==b)return c}a.$watch(function(){return c.subject},function(){a.refresh()}),a.getPosts=function(){return a.info.end?void alert("포스트가 없습니다."):(a.info.start=a.info.page*a.info.size,void b("/api/post/list",a.info).success(function(b){return null==b?void(a.info.end=!0):(a.info.page++,void a.titles.addAll(b))}))},a.refresh=function(){void 0!=c.subject&&(a.info={},a.info.subject=c.subject,a.info.end=!1,a.info.page=0,a.titles=[],void 0==a.info.size&&(a.info.size=5),a.getPosts())},a.refresh(),a["delete"]=function(b){var c=e(b);void 0!=c&&a.titles.splice(c,1)},a.update=function(b){var c=e(b.id);if(void 0!=c){var d=a.titles[c];d.title=b.title}}}),app.controller("headerController",function(a,b){a.$watch(function(){return b.subject},function(){a.subject=b.subject})}),app.controller("loginController",function(a,b,c){a.user=c,a.login=function(){b("/api/user/login",c,"POST").success(function(a){return a?(alert("로그인 성공!"),void(c.logged=!0)):void alert("로그인 실패!")})},a.logout=function(){b("/api/user/logout").success(function(a){return a?(alert("로그아웃 성공!"),void(c.logged=!1)):void alert("로그아웃 실패!")})},a.register=function(){b("/api/user",c,"POST").success(function(a){return a?void alert("회원가입 성공!"):void alert("회원가입 실패!")})}}),app.controller("searchController",function(a,b,c){function d(a,b){this.subject=a,this.count=b}a.results=[],a.$watch("keyword",function(){return""==a.keyword?void(a.results=[]):void(void 0!=a.keyword&&b("/api/search",{keyword:a.keyword}).success(function(b){return null==b?void(a.results=[]):void(a.results=b)}))}),a.$watch(function(){return a.results},function(){if(void 0!=a.keyword&&""!=a.keyword){a.select=0;for(var b=0;b<a.results.length;b++)if(a.results[b].subject==a.keyword)return;a.results.push(new d(a.keyword,0))}}),a.isSelected=function(b){return a.results.indexOf(b)==a.select},a.sel=function(b){a.select=a.results.indexOf(b)},a.movePage=function(b){c.path(b.subject),a.keyword=""},a.move=function(b){if(0!=a.results.length)switch(b.keyCode){case 13:if(void 0==a.results[a.select])return;return void a.movePage(a.results[a.select]);case 38:return 0==a.select?void(a.select=a.results.length-1):void a.select--;case 40:return a.select==a.results.length-1?void(a.select=0):void a.select++}}});